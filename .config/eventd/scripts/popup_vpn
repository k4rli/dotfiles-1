#!/bin/bash

VPN_ICON='î‚²'

VPN_COLOR_URGENT='RRR'
VPN_COLOR_CONNECTED='7E4'
VPN_COLOR_DISCONNECTED='E44'

VPN_UUID=`uuidgen`

status_vpn(){
	systemctl is-active openvpn-client@home >/dev/null
	if (($? == 0)) && ! $vpn_connected; then
		markup $VPN_ICON "Home" $VPN_COLOR_CONNECTED
		vpn_connected=true
		return
	else
		pidof openconnect >/dev/null
		if (($? == 0)) && ! $vpn_connected; then
			markup $VPN_ICON "NTNU" $VPN_COLOR_CONNECTED
			vpn_connected=true
			return
		fi
	fi

	if $vpn_connected; then
		markup $VPN_ICON "Disconnected" $VPN_COLOR_URGENT
		vpn_connected=false
	fi
}

watch_vpn(){
	journalctl -fu systemd-networkd | while read -r event; do
		status=`status_vpn`
		[[ -n "$status" ]] && popup "${status//RRR/$VPN_COLOR_DISCONNECTED}" topright $VPN_UUID
	done
}
