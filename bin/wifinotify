#!/bin/sh

# uses notify-send to announce status of wifi connections
#
# requires:
# - systemd-networkd (for networkctl)
# - wpa_supplicant (for wpa_cli)
# - libnotify (for notify-send)
# - awk

iface=$(networkctl list --no-legend | awk '$3 == "wlan" {print $2}')

poke(){
	while true; do
		printf '\n'
		sleep 1
	done
}

ssid(){
	echo "$(wpa_cli -i $iface status | awk -F'=' '/^ssid=/ {print $2}')"
}

(poke) | wpa_cli -i $iface | while read line; do
	if ! [[ "$line" == ">" ]]; then
		# echo "$line"
		case "$line" in
			*'CTRL-EVENT-CONNECTED'*)
				notify-send 'WiFi' "Connected to '$(ssid)'"
				;;
			*'CTRL-EVENT-DISCONNECTED'*)
				if ! [[ "$line" = *reason=2* ]]; then
					notify-send 'WiFi' 'Disconnected'
				fi
				;;
			*'CTRL-EVENT-SSID-TEMP-DISABLED'*)
				if [[ "$line" = *WRONG_KEY* && "$line" = *auth_failures=1* ]]; then
					notify-send 'WiFi' 'Authentication failed!'
				fi
				;;
		esac
	fi
done
